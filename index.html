<!DOCTYPE html>
<html lang="en" class="bg-slate-50 text-slate-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creswell Missionaries</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.x/css/materialdesignicons.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <meta name="apple-mobile-web-app-title" content="Creswell Missionaries">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#f8fafc">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/854/854878.png">

    <style>
        [x-cloak] { display: none !important; }
        #main-map { height: 350px; width: 100%; z-index: 1; }
        #modal-map { height: 300px; width: 100%; z-index: 1; }
        @media (min-width: 768px) { #main-map { height: 500px; border-radius: 1rem; } }
        
        .custom-pin { background: transparent; border: none; }
        .pin-inner { width: 45px; height: 45px; border-radius: 50%; border: 3px solid white; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.4); background: #334155;}
        .pin-inner img { width: 100%; height: 100%; object-fit: cover; }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    </style>
</head>

<body x-data="missionaryApp()" x-init="initApp()" class="min-h-screen antialiased pb-12 bg-slate-50">

    <div class="relative w-full md:max-w-6xl md:mx-auto md:mt-6 shadow-xl overflow-hidden border-b md:border border-slate-200 bg-white md:rounded-2xl">
        <div id="main-map"></div>
        
        <div class="absolute top-4 left-4 z-[1000] bg-white/90 backdrop-blur px-5 py-3 rounded-xl border border-slate-200 shadow-lg">
            <h1 class="text-xl font-bold text-slate-800 tracking-tight">Creswell Ward</h1>
            <div class="text-blue-600 text-xs font-bold uppercase tracking-wide flex items-center gap-2 mt-1">
                <span class="mdi mdi-earth"></span>
                <span x-text="fleet.length + ' Missionaries Serving'"></span>
            </div>
        </div>
    </div>

    <main class="max-w-6xl mx-auto p-4 md:p-6 mt-4">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
            <template x-for="person in fleet" :key="person.id">
                <div @click="openModal(person)" 
                     class="group bg-white hover:bg-slate-50 border border-slate-200 rounded-xl p-4 flex items-center gap-4 cursor-pointer transition-all hover:shadow-md hover:border-blue-200">
                    <img :src="person.photo_url" class="w-16 h-16 rounded-full object-cover border-2 border-slate-100 group-hover:border-blue-400 transition-colors shadow-sm">
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start">
                            <h2 class="font-bold text-lg text-slate-800 truncate" x-text="person.short_name"></h2>
                            <img :src="'https://flagcdn.com/w20/' + person.country_code + '.png'" class="rounded-sm opacity-80 shadow-sm">
                        </div>
                        <p class="text-slate-500 text-sm truncate mb-3" x-text="person.mission_name"></p>
                        
                        <div class="flex items-center gap-2 overflow-x-auto no-scrollbar">
                            <div class="bg-blue-50 text-blue-700 px-2.5 py-1 rounded-full text-xs font-semibold whitespace-nowrap border border-blue-100">
                                <span x-text="getDaysLeft(person.return_date)"></span> Days Left
                            </div>
                            <div class="bg-slate-100 text-slate-600 px-2.5 py-1 rounded-full text-xs font-semibold whitespace-nowrap border border-slate-200 flex items-center gap-1">
                                <span class="mdi mdi-clock-outline text-xs"></span>
                                <span x-text="getLocalTime(person.timezone)"></span>
                            </div>
                            <div class="bg-orange-50 text-orange-700 px-2.5 py-1 rounded-full text-xs font-semibold whitespace-nowrap border border-orange-100 flex items-center gap-1" x-show="person.weather">
                                <span class="mdi" :class="getWeatherIcon(person.weather?.current?.weather_code)"></span>
                                <span x-text="Math.round(person.weather?.current?.temperature_2m) + 'Â°F'"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </main>

    <div x-show="selectedPerson" x-cloak 
         class="fixed inset-0 z-[2000] flex items-center justify-center p-4"
         x-transition.opacity>
        
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" @click="closeModal()"></div>

        <div class="relative w-full max-w-lg bg-white rounded-2xl shadow-2xl overflow-hidden max-h-[90vh] overflow-y-auto"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="translate-y-8 opacity-0 scale-95"
             x-transition:enter-end="translate-y-0 opacity-100 scale-100">
            
            <button @click="closeModal()" class="absolute top-4 right-4 z-10 p-2 bg-black/10 hover:bg-black/20 rounded-full transition">
                <span class="mdi mdi-close text-slate-800"></span>
            </button>

            <div class="text-center p-8 bg-slate-50 border-b border-slate-100">
                <img :src="selectedPerson?.photo_url" class="w-28 h-28 rounded-full mx-auto mb-4 object-cover border-4 border-white shadow-lg">
                <h2 class="text-2xl font-bold text-slate-900" x-text="selectedPerson?.full_name"></h2>
                <p class="text-blue-600 font-medium" x-text="selectedPerson?.mission_name"></p>
            </div>

            <div class="p-4 grid grid-cols-3 gap-2 bg-white border-b border-slate-100">
                <div class="text-center p-2 rounded-lg bg-slate-50 border border-slate-100">
                    <div class="text-[10px] uppercase font-bold text-slate-400">Return</div>
                    <div class="text-sm font-bold text-slate-700" x-text="formatDateShort(selectedPerson?.return_date)"></div>
                    <div class="text-[10px] text-blue-600 font-medium" x-text="getDaysLeft(selectedPerson?.return_date) + ' Days'"></div>
                </div>
                <div class="text-center p-2 rounded-lg bg-slate-50 border border-slate-100">
                    <div class="text-[10px] uppercase font-bold text-slate-400">Time</div>
                    <div class="text-sm font-bold text-slate-700" x-text="getLocalTime(selectedPerson?.timezone)"></div>
                    <div class="text-[10px] text-slate-400 font-medium" x-text="getTimeDiff(selectedPerson?.timezone)"></div>
                </div>
