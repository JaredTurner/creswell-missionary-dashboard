<!DOCTYPE html>
<html lang="en" class="bg-slate-900 text-slate-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Missionary Fleet</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.x/css/materialdesignicons.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <meta name="apple-mobile-web-app-title" content="Missionary Fleet">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/854/854878.png">

    <style>
        [x-cloak] { display: none !important; }
        #main-map { height: 350px; width: 100%; z-index: 1; }
        @media (min-width: 768px) { #main-map { height: 500px; border-radius: 1rem; } }
        /* Custom Pin */
        .custom-pin { background: transparent; border: none; }
        .pin-inner { width: 45px; height: 45px; border-radius: 50%; border: 3px solid white; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.4); background: #334155;}
        .pin-inner img { width: 100%; height: 100%; object-fit: cover; }
        /* Dark Theme Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    </style>
</head>

<body x-data="missionaryApp()" x-init="initApp()" class="min-h-screen antialiased pb-12 bg-slate-900">

    <div class="relative w-full md:max-w-6xl md:mx-auto md:mt-6 shadow-2xl overflow-hidden border-b md:border border-slate-700 bg-slate-800 md:rounded-2xl">
        <div id="main-map"></div>
        
        <div class="absolute top-4 left-4 z-[1000] bg-slate-900/90 backdrop-blur px-5 py-3 rounded-xl border border-slate-600 shadow-xl">
            <h1 class="text-xl font-bold text-white tracking-tight">Creswell Ward Missionaries</h1>
            <div class="text-blue-400 text-xs font-bold uppercase tracking-wide flex items-center gap-2 mt-1">
                <span class="mdi mdi-earth"></span>
                <span x-text="fleet.length + ' Missionaries'"></span>
            </div>
        </div>
    </div>

    <main class="max-w-6xl mx-auto p-4 md:p-6 mt-4">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
            <template x-for="person in fleet" :key="person.id">
                <div @click="openModal(person)" 
                     class="group bg-slate-800 hover:bg-slate-700/80 border border-slate-700 rounded-xl p-4 flex items-center gap-4 cursor-pointer transition-all hover:shadow-lg hover:border-blue-500/30">
                    
                    <img :src="person.photo_url" class="w-16 h-16 rounded-full object-cover border-2 border-slate-600 group-hover:border-blue-400 transition-colors shadow-sm">
                    
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start">
                            <h2 class="font-bold text-lg text-white truncate" x-text="person.short_name"></h2>
                            <img :src="'https://flagcdn.com/w20/' + person.country_code + '.png'" class="rounded-sm opacity-80 shadow-sm">
                        </div>
                        <p class="text-slate-400 text-sm truncate mb-3" x-text="person.mission_name"></p>
                        
                        <div class="flex items-center gap-2 overflow-x-auto no-scrollbar">
                            <div class="bg-blue-900/30 text-blue-200 px-2.5 py-1 rounded-full text-xs font-semibold whitespace-nowrap border border-blue-500/20">
                                <span x-text="getDaysLeft(person.return_date)"></span> Days Left
                            </div>
                            
                            <div class="bg-slate-700/50 text-slate-300 px-2.5 py-1 rounded-full text-xs font-semibold whitespace-nowrap border border-slate-600/50 flex items-center gap-1">
                                <span class="mdi mdi-clock-outline text-xs"></span>
                                <span x-text="getLocalTime(person.timezone)"></span>
                            </div>

                            <div class="bg-orange-900/30 text-orange-200 px-2.5 py-1 rounded-full text-xs font-semibold whitespace-nowrap border border-orange-500/20 flex items-center gap-1" x-show="person.weather">
                                <span class="mdi" :class="getWeatherIcon(person.weather?.current?.weather_code)"></span>
                                <span x-text="Math.round(person.weather?.current?.temperature_2m) + 'Â°F'"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </main>

    <div x-show="selectedPerson" x-cloak 
         class="fixed inset-0 z-[2000] flex items-center justify-center p-4"
         x-transition.opacity>
        
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" @click="selectedPerson = null"></div>

        <div class="relative w-full max-w-lg bg-slate-900 rounded-2xl shadow-2xl overflow-hidden max-h-[90vh] overflow-y-auto border border-slate-700"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="translate-y-8 opacity-0 scale-95"
             x-transition:enter-end="translate-y-0 opacity-100 scale-100">
            
            <button @click="selectedPerson = null" class="absolute top-4 right-4 z-10 p-2 bg-black/40 hover:bg-white/10 rounded-full transition">
                <span class="mdi mdi-close text-white"></span>
            </button>

            <div class="text-center p-8 bg-slate-800 border-b border-slate-700">
                <img :src="selectedPerson?.photo_url" class="w-28 h-28 rounded-full mx-auto mb-4 object-cover border-4 border-slate-700 shadow-xl">
                <h2 class="text-2xl font
